# Настройка HiggsNode для Windows 11

## Обзор

HiggsNode теперь полностью поддерживает Windows 11. При установке и запуске ноды автоматически настраиваются все необходимые компоненты для работы VPN.

## Архитектура

HiggsNode - это специальная нода, которая:
- Регистрируется на **BosonServer** (mail.highfunk.uk с реальным IP)
- Принимает трафик от **клиентов** (WireGuard clients) через BosonServer
- Маршрутизирует трафик клиентов в интернет через свой физический интерфейс
- Обеспечивает доступ клиентов в интернет через NAT

**Поток трафика:**
```
Клиент (WireGuard) 
  → BosonServer (mail.highfunk.uk) [Relay]
  → HiggsNode (ваш ПК)
  → Физический интерфейс (192.168.0.x)
  → Роутер
  → Интернет
```

## Что настраивается автоматически

### 1. IP Forwarding (Пересылка IP пакетов)

Включается через реестр Windows:
- Путь: `HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters`
- Параметр: `IPEnableRouter = 1`

**Важно:** После первого включения может потребоваться перезагрузка системы.

### 2. Маршрутизация

Автоматически настраиваются маршруты:
- Маршрут для WireGuard подсети через WireGuard интерфейс
- Проверка и настройка default route через физический интерфейс

### 3. Windows Firewall

Настраиваются правила для forwarding трафика:
- Разрешение трафика от WireGuard интерфейса к физическому интерфейсу
- Разрешение обратного трафика от физического интерфейса к WireGuard

### 4. NAT (Network Address Translation)

Windows автоматически выполняет NAT для трафика, идущего через default gateway. Дополнительно настраивается:
- Маршрутизация для WireGuard подсети
- Firewall правила для forwarding

## Архитектура сети

```
Клиент (10.8.0.2 в WireGuard сети)
  ↓
WireGuard интерфейс ноды (10.8.0.1)
  ↓ [NAT #1 на ноде: 10.8.0.2 → 192.168.0.100]
Физический интерфейс ноды (192.168.0.100)
  ↓
Роутер (192.168.0.1)
  ↓ [NAT #2 на роутере: 192.168.0.100 → публичный IP]
Интернет
```

## Требования

1. **Права администратора** - обязательно для настройки сети
2. **WireGuard** - должен быть установлен
3. **Windows 11** - рекомендуется (также работает на Windows 10)

## Установка

### Автоматическая установка (рекомендуется)

1. Установите WireGuard для Windows:
   - Скачайте с https://www.wireguard.com/install/
   - Установите и перезагрузите компьютер

2. Установите Node.js 20.x или выше с https://nodejs.org/

3. Запустите скрипт установки от имени администратора:

   **Вариант A: Через .bat файл (проще)**
   - Щелкните правой кнопкой мыши на `install.bat`
   - Выберите "Запуск от имени администратора"

   **Вариант B: Через PowerShell**
   ```powershell
   # Откройте PowerShell от имени администратора
   cd higgsnode
   .\install.ps1
   ```

   Скрипт автоматически:
   - Проверит все требования (Windows, Node.js, WireGuard)
   - Проверит сетевые интерфейсы
   - Установит зависимости
   - Соберет проект
   - Создаст .env файл из .env.example
   - Выполнит проверку установки

4. Запустите ноду:

   **Вариант A: Через .bat файл (проще)**
   - Щелкните правой кнопкой мыши на `start-node.bat`
   - Выберите "Запуск от имени администратора"

   **Вариант B: Через командную строку**
   ```powershell
   npm start
   ```

   **Вариант C: Установка с автоматическим запуском**
   ```powershell
   .\install.ps1 -AutoStart
   ```

### Ручная установка

1. Установите WireGuard для Windows:
   - Скачайте с https://www.wireguard.com/install/
   - Установите и перезагрузите компьютер

2. Установите Node.js 20.x или выше

3. Установите зависимости:
   ```bash
   cd higgsnode
   npm install
   ```

4. Настройте конфигурацию:
   ```bash
   # Windows
   copy .env.example .env
   
   # Отредактируйте .env и укажите:
   # BOSON_SERVER_URL=https://mail.highfunk.uk (уже установлено по умолчанию)
   ```

5. Соберите проект:
   ```bash
   npm run build
   ```

6. Запустите с правами администратора:
   ```bash
   # Запустите PowerShell или CMD от имени администратора
   npm start
   ```

**При первом запуске:**
- Нода автоматически сгенерирует WireGuard ключи
- Зарегистрируется на BosonServer (mail.highfunk.uk)
- Настроит маршрутизацию и NAT
- Начнет принимать соединения от клиентов

## Проверка работы

После запуска проверьте:

1. **IP Forwarding:**
   ```powershell
   Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "IPEnableRouter"
   ```
   Должно быть: `IPEnableRouter : 1`

2. **Маршруты:**
   ```cmd
   route print
   ```
   Должен быть маршрут для WireGuard подсети

3. **Firewall правила:**
   ```cmd
   netsh advfirewall firewall show rule name=all | findstr HiggsNode
   ```
   Должны быть правила с префиксом `HiggsNode-`

4. **WireGuard интерфейс:**
   ```cmd
   wg show
   ```
   Должен показывать активный интерфейс

## Устранение проблем

### Проблема: IP Forwarding не включается

**Решение:**
1. Убедитесь, что запускаете от имени администратора
2. Попробуйте включить вручную:
   ```powershell
   Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "IPEnableRouter" -Value 1 -Type DWord
   ```
3. Перезагрузите компьютер

### Проблема: Трафик не проходит

**Решение:**
1. Проверьте, что физический интерфейс определен правильно:
   ```cmd
   route print 0.0.0.0
   ```
2. Проверьте firewall правила:
   ```cmd
   netsh advfirewall firewall show rule name=all
   ```
3. Проверьте, что WireGuard интерфейс активен:
   ```cmd
   wg show
   ```

### Проблема: Ошибка при добавлении маршрута

**Решение:**
1. Убедитесь, что WireGuard интерфейс создан
2. Проверьте имя интерфейса:
   ```cmd
   netsh interface show interface
   ```
3. Попробуйте добавить маршрут вручную:
   ```cmd
   route add <subnet> mask <mask> <interface_name> metric 1
   ```

## Очистка при остановке

При остановке ноды (`Ctrl+C` или `npm stop`):
- Удаляются все firewall правила с префиксом `HiggsNode-`
- Маршруты остаются (Windows автоматически очистит их при перезагрузке)

Для полной очистки:
```cmd
# Удалить все правила HiggsNode
netsh advfirewall firewall delete rule name=all | findstr HiggsNode

# Удалить маршруты (если нужно)
route delete <subnet>
```

## Особенности Windows

### Двойной NAT

Windows использует двойной NAT:
1. NAT на ноде: `10.8.0.x → 192.168.0.x`
2. NAT на роутере: `192.168.0.x → публичный IP`

Это нормально и работает для большинства протоколов.

### Ограничения

- Windows не имеет прямого эквивалента `iptables MASQUERADE`
- NAT работает через комбинацию маршрутизации и firewall правил
- Некоторые протоколы (FTP, SIP) могут требовать дополнительной настройки

## Логирование

Логи сохраняются в:
- Консоль (при запуске через `npm start`)
- Файл логов (если настроен в конфигурации)

Для отладки используйте:
```bash
npm start -- --verbose
```

## Поддержка

При возникновении проблем:
1. Проверьте логи
2. Запустите диагностику: `npm run diagnose` (если доступно)
3. Проверьте требования выше

---

*Документ обновлен: Декабрь 2024*

